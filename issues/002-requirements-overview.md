# 002 - 需求全景

## 概述

AgentVM 是 AI 智能体运行时，在 AgentX 之上提供托管服务和增量能力。

---

## 架构全景

```
┌──────────────────────────────────────────────────────────────────┐
│                          AgentVM                                  │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    1. Agent 基础（AgentX 域）               │  │
│  │  WebSocket · Container 隔离 · Image · Session · 流式输出   │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    2. 资源中心                              │  │
│  │  万物皆资源：Prompt · Tool · Sandbox · Agent · Knowledge    │  │
│  │  能力：发现 · 注册 · 引用 · 版本 · 依赖                     │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    3. 会话中心                              │  │
│  │  对话历史 · 上下文 · 多轮管理 · 持久化                      │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    4. 配置中心                              │  │
│  │  LLM 配置 · 系统参数 · 环境变量 · 默认值                    │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    5. 可观测                                │  │
│  │  日志 · Token 用量 · 错误追踪 · 性能指标                    │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    6. 认证与租户                            │  │
│  │  身份认证 · 权限控制 · 多租户隔离 · API Key                 │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## 六大需求模块

| #   | 模块           | 核心问题             | 协议                | 优先级 |
| --- | -------------- | -------------------- | ------------------- | ------ |
| 1   | **Agent 基础** | 智能体怎么跑         | WebSocket（AgentX） | P0     |
| 2   | **资源中心**   | 资源怎么管理和引用   | HTTP                | P1     |
| 3   | **会话中心**   | 对话怎么持久化和恢复 | AgentX 内置         | P0     |
| 4   | **配置中心**   | 系统怎么配置         | HTTP                | P1     |
| 5   | **可观测**     | 运行状态怎么看       | HTTP                | P2     |
| 6   | **认证租户**   | 谁能访问什么         | HTTP + WebSocket    | P2     |

---

## 1. Agent 基础（AgentX 域）

**已由 AgentX 提供，AgentVM 直接集成。**

### 核心能力

- Container 级别用户隔离
- Image（对话）管理
- Agent 生命周期（创建、运行、停止、恢复）
- 消息发送和流式响应
- 事件系统（30+ 种事件）

### 用户流程

```
用户认证 → 分配 Container → WebSocket 连接 → AgentX 操作
```

### 参考

- Issue: [001-agentx-integration](./001-agentx-integration.md)

---

## 2. 资源中心

**万物皆资源，统一管理。**

### 资源类型

| 类型      | 说明            | 示例                                 |
| --------- | --------------- | ------------------------------------ |
| Prompt    | 提示词/角色定义 | `resource://prompts/sales-assistant` |
| Tool      | 工具/能力       | `resource://tools/web-search`        |
| Sandbox   | 执行环境        | `resource://sandboxes/python`        |
| Agent     | Agent 定义      | `resource://agents/translator`       |
| Knowledge | 知识库/RAG      | `resource://knowledge/company-docs`  |

### 核心能力

```
POST   /v1/resources           # 注册资源
GET    /v1/resources           # 发现资源
GET    /v1/resources/:id       # 获取资源
PUT    /v1/resources/:id       # 更新资源
DELETE /v1/resources/:id       # 删除资源
GET    /v1/resources/resolve   # 解析 URI
```

### 用户故事

- 我想注册一个新的 Prompt
- 我想发现有哪些可用的 Tool
- 我想让 Agent 引用 `resource://prompts/sales-v2`

---

## 3. 会话中心

**对话历史管理。**

### 核心能力

AgentX 已内置：

- Session 持久化（SQLite）
- 消息历史
- 多轮对话

AgentVM 可能需要增强：

- 跨设备会话同步
- 会话导出/导入
- 会话搜索

---

## 4. 配置中心

**系统级配置管理。**

### 配置类型

```yaml
# LLM 配置
llm:
  provider: anthropic
  model: claude-sonnet-4-20250514
  apiKey: ${LLM_API_KEY}

# 系统配置
system:
  dataDir: ~/.agentvm
  logLevel: info

# 默认值
defaults:
  timeout: 30000
  maxTokens: 4096
```

### 核心能力

```
GET    /v1/config              # 获取配置
PUT    /v1/config              # 更新配置
GET    /v1/config/:key         # 获取单个配置
```

---

## 5. 可观测

**运行状态监控。**

### 核心能力

```
GET    /v1/metrics             # 获取指标
GET    /v1/logs                # 获取日志
GET    /v1/usage               # Token 用量统计
```

### 指标类型

- 请求数/成功率
- Token 消耗（input/output）
- 响应时间
- 活跃 Container 数
- 错误率

---

## 6. 认证与租户

**身份和权限管理。**

### 核心能力

- API Key 认证
- WebSocket 握手验证
- Container 级别隔离（userId ↔ containerId）
- 用量配额

### 用户流程

```
1. 获取 API Key
2. HTTP 请求带 Authorization header
3. WebSocket 连接带 token 参数
4. 验证后分配/绑定 Container
```

---

## 迭代计划

### Phase 1: MVP

```
目标：能跑起来

- [x] 项目初始化
- [ ] 001 AgentX 集成
  - HTTP Server
  - AgentX WebSocket
  - Container 隔离
```

### Phase 2: 管理能力

```
目标：能管理

- [ ] 资源中心（基础）
- [ ] 配置中心（基础）
```

### Phase 3: 生产就绪

```
目标：能上线

- [ ] 认证
- [ ] 可观测
- [ ] 资源中心（完整）
```

---

## 模块关系

```
                    ┌──────────────┐
                    │  认证与租户   │
                    └──────┬───────┘
                           │ 身份上下文
                           ▼
┌──────────┐  配置   ┌──────────────┐
│ 配置中心  │◄───────│  Agent 基础   │
└──────────┘         │  (AgentX)    │
                     └──────┬───────┘
              ┌─────────────┼─────────────┐
              │             │             │
              ▼             ▼             ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐
        │ 资源中心  │ │ 会话中心  │ │  可观测   │
        └──────────┘ └──────────┘ └──────────┘
```

---

## 技术栈

| 层级       | 选型                     |
| ---------- | ------------------------ |
| 运行时     | Bun                      |
| HTTP 框架  | Hono                     |
| Agent 引擎 | AgentX                   |
| 持久化     | SQLite（本地）/ D1（云） |
| 构建       | Turborepo                |
| 测试       | Bun test + Cucumber BDD  |
